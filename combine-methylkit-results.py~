'''Summary for the script'''
import sys
import argparse

import csv
import json
import os.path


if sys.version_info[0] < 3:
    raise Exception("Python 3 or a more recent version is required.")

parser = argparse.ArgumentParser()
parser.add_argument('--base', required=True, help='Base Methylkit result file')
parser.add_argument('--gene-annot', required=True, help='Nearest Gene file')
parser.add_argument('--relationship', required=True, help='Relationship to Nearest Gene')
parser.add_argument('--gff', required=True, help='GFF File')
parser.add_argument('--id-cache', required=True, help='File to Cache IDs in')
parser.add_argument('--liftover', help='Path to file for liftover mapping')
parser.add_argument('--id-prefix', required=True, help='Prefix for Feature ID')
parser.add_argument('--file-prefix', required=True, help='Prefix for file name')
args = parser.parse_args()

def parse_gff():
    '''Extract gene names from gff file'''

    gene_map = {}
    transcript_map = {}

    t = { x:None for x in ['transcript', 'pseudogenic_transcript', 'lnc_RNA', 'mRNA',
                           'unconfirmed_transcript', 'snoRNA', 'rRNA', 'snRNA',
                           'miRNA', 'ncRNA', 'scRNA', 'V_gene_segment', 'C_gene_segment']}

    with open(args.gff, newline='') as tsvfile:
        reader = csv.reader(tsvfile, delimiter='\t')
        for row in reader:
            if row[0][0] == '#':
                continue

            x = row[8].split(';')
            attr = {}
            
            for y in x:
                z = y.split('=')
                attr[z[0]] = z[1]

            if row[2] == 'gene' or row[2] == 'pseudogene' or row[2] == 'ncRNA_gene':
                if 'Name' in attr:
                    gene_map[attr['ID']] = [attr['Name'], row[2]]
                else:
                    gene_map[attr['ID']] = [attr['gene_id'], row[2]]

            elif row[2] in t:
                transcript_map[attr['transcript_id']] = [attr['Parent'], row[2]]

    for x in transcript_map:
        transcript_map[x] = [gene_map[transcript_map[x][0]][0],
                             transcript_map[x][1],
                             gene_map[transcript_map[x][0]][1]
                             ]
    return transcript_map


if __name__ == '__main__':

    gene_map = parse_gff()

    features = {}

    ids = { 'next' : 1 }
    
    liftover_map = {}

    if args.liftover:
        with open(args.liftover, newline='') as tsvfile:
            reader = csv.reader(tsvfile, delimiter='\t')
            for row in reader:
                liftover_map[row[1]] = row[0]

    # if there are already ids cached, use them
    if os.path.isfile(args.id_cache):
        with open(args.id_cache) as f:
            ids = json.load(f)

    with open(args.base, newline='') as tsvfile:
        reader = csv.reader(tsvfile, delimiter='\t')
        next(reader)
        i = 1
        for row in reader:

            # dictionary for data
            d = {}

            # determine the id
            k = row[1] + ':' + row[2]

            if k not in ids:
                ids[k] = ids['next']
                ids['next'] += 1

            d['id'] = f'{args.file_prefix}{args.id_prefix}.{row[0]}'
            d['newid'] = f'{args.id_prefix}{ids[k]:06}'
            d['chr'] = row[1]
            d['start'] = row[2]
            d['stop'] = row[3]
            d['pval'] = row[5]
            d['qval'] = row[6]
            d['mdiff'] = row[7]

            # if we are doing a liftover look for an infiniumid
            if args.liftover and k in liftover_map:
                d['infiniumid'] = liftover_map[k]

            # save it
            features[str(i)] = d
            i += 1

    # save json ids
    with open(args.id_cache, 'w') as f:
        json.dump(ids, f)

    # now read gene annotation
    with open(args.gene_annot, newline='') as tsvfile:
        reader = csv.reader(tsvfile, delimiter='\t')
        next(reader)
        for row in reader:

            [gene, feature_type, gene_type] = gene_map[row[3]]

            # index
            i = row[1]

            features[i]['gene'] = gene
            features[i]['gene-distance'] = row[2]
            features[i]['gene-strand'] = row[4]
            features[i]['feature-type'] = feature_type
            features[i]['gene-type'] = gene_type

    # now neighborhood information
    with open(args.relationship, newline='') as tsvfile:
        reader = csv.reader(tsvfile, delimiter='\t')
        next(reader)
        for row in reader:
            
            # index
            i = row[0]

            features[i]['in-promoter'] = 'Yes' if row[1] == '1' else 'No'
            features[i]['in-exon'] = 'Yes' if row[2] == '1' else 'No'
            features[i]['in-intron'] = 'Yes' if row[3] == '1' else 'No'

    # use a dictwriter to spit to file

    cols = ['id', 'newid', 'chr', 'start', 'stop', 'pval', 'qval', 'mdiff', 'gene', 
            'gene-distance', 'gene-strand', 'feature-type', 'gene-type', 'in-promoter',
               'in-exon', 'in-intron' ]

    if args.liftover:
        cols.insert(2, 'infiniumid')

    with open(f'{args.file_prefix}-{args.id_prefix}-methylkit-sig.csv', 'w') as outfile:
        writer = csv.DictWriter(outfile, cols, delimiter=',')
        writer.writeheader()
        for v in features.values():
            writer.writerow(v)
